swagger: "2.0"
info:
  description: "Search API"
  version: "1.0.1"
  title: "dp-search-api"
  license:
    name: "Open Government Licence v3.0"
    url: "http://www.nationalarchives.gov.uk/doc/open-government-licence/version/3/"
basePath: "/v1"
schemes:
  - "http"
tags:
  - name: "search"
  - name: "department"
  - name: "health"
  - name: "data"

paths:
  /data:
    get:
      tags:
        - data
      summary: ""
      description: ""
      parameters:
        - in: query
          name: uris
          description:
          type: string
          required: true
        - in: query
          name: types
          description:
          type: string
          required: true
  /search:
    get:
      tags:
        - search
      summary: "Default ONS query API"
      description: "Default ONS query API which combines the content with type counts"
      parameters:
        - in: query
          name: q
          description: "Query search term."
          type: string
          required: true
        - in: query
          name: content_type
          description: "Comma separated list of content types to be returned."
          type: array
          uniqueItems: true
          items:
            type: string
          collectionFormat: csv
          required: false
        - in: query
          name: from
          description:
          default: 0
          type: string
          required: false
        in: query
          name: index
          description:
          type: integer
          required: false
        in: query
          name: type
          description:
          type: string
          required: false
        in: query
          name: aggField
          description: "The field that will be used to group on by the `count` query"
          type:
          required: false
        in: query
          name: withFirstLetter
          description: "Restricted to `search` queries will only return results where the title starts with the letter `?`"
          type: string
          enum: [a..Z]
          required:
        in: query
          name: uriPrefix
          description: "Prefix filter on the URI."
          type: string
          required: false
        in: query
          name: topic
          description: "Topic filter, matches exact Topic."
          type: string
          required: false
        in: query
          name: topicWildcard
          description: "Matches Topics using Wildcard pattern matching."
          type: string
          required: false
        in: query
          name: highlight
          description: "Determines whether to include highlighting on the `SEARCH` results."
          type: boolean
          required:
        in: query
          name: upcoming
          description: "Determines whether items in the `SEARCH` that are not published and not cancelled __OR__ are published and are not due."
          type: boolean
          required:
        in: query
          name: published
          description: "Determines whether items in the `SEARCH` that are published and not cancelled __OR__ are cancelled and are due."
          type: boolean
          required:
        in: query
          name: queries
          description:
          type: string
          enum: [search, counts, departments, featured]
          required: false
        - in: query
          name: size
          description: "Number of returned results"
          type: integer
          default: 10
          required: true
        - in: query
          name: sort
          description: "The order to return the results."
          type: string
          default: "relevance"
          enum: [relevance, release_date, release_date_asc, first_letter, title]
          required: false
        - in: query
          name: limit
          description: "The number of items requested, defaulted to 50 and limited to 1000."
          default: "search"
          type: integer
          required: false
        - in: query
          name: offset
          description: "The first row of resources to retrieve, starting at 0. Use this parameter as a pagination mechanism along with the limit parameter."
          type: integer
          required: false
        -
      responses:
        200:
          description: OK
          schema:
            $ref: "#/definitions/SearchResponse"
        400:
          description: Query term not specified
        500:
          description: Internal server error

  /timeseries/{cdid}:
    get:
      tags:
        - timeseries
      summary:
      description:

  /departments/search:
    get:
      tags:
        - department
      summary: "Department query API"
      description: "Department query API which returns matching links to other departments"
      parameters:
        - in: query
          name: q
          description: "Query search term"
          type: string
          required: true
        - in: query
          name: limit
          description: "The number of items requested, defaulted to 50 and limited to 1000."
          type: integer
          required: false
        - in: query
          name: offset
          description: "The first row of resources to retrieve, starting at 0. Use this parameter as a pagination mechanism along with the limit parameter."
          type: integer
          required: false
      responses:
        200:
          description: OK
          schema:
            $ref: "#/definitions/DepartmentResponse"
        400:
          description: Query term not specified
        500:
          description: Internal server error

  /health:
    get:
      tags:
        - health
      summary: "Health check API"
      description: "API to query the app for current health status"
      responses:
        200:
          description: OK
          schema:
            $ref: "#/definitions/Health"
        500:
          description: Internal Server Error

definitions:
  SearchResponse:
    type: object
    properties:
      count:
        type: number
        description: "Number of search results which match query"
        example: 80
      took:
        type: number
        description: "Time taken to execute query in milliseconds"
        example: 530
      content_types:
        type: array
        description: "List of content types included in results"
        items:
          $ref: "#/definitions/ContentType"
      items:
        type: array
        description: "List of matching content items for the current page"
        items:
          $ref: "#/definitions/ContentItem"
      suggestions:
        type: array
        description: "List of suggested alternative similar search queries"  
        items:
          type: string
    required:
      - count
      - took
      - content_types
      - items

  DepartmentResponse:
    type: object
    properties:
      count:
        type: number
        description: "Number of search results which match query"
        example: 80
      took:
        type: number
        description: "Time taken to execute query in milliseconds"
        example: 530
      items:
        type: array
        description: "List of matching content items for the current page"
        items:
          $ref: "#/definitions/DepartmentItem"
    required:
      - count
      - took

  ContentType:
    type: object
    properties:
      type:
        type: string
      count:
        type: integer
    required:
      - "type"
      - "count"

  ContentItem:
    type: object
    properties:
      description:
        type: object
        properties:
          contact:
            type: object
            properties:
              email:
                type: string
              name:
                type: string
              telephone:
                type: string
            required:
              - name
              - email
          dataset_id:
            type: string
          edition:
            type: string
          headline1:
            type: string
          headline2:
            type: string
          headline3:
            type: string
          keywords:
            type: array
            items:
              type: string
          latest_release:
            type: boolean
          language:
            type: string
            example: "English"
          meta_description:
            type: string
          national_statistic:
            type: boolean
          next_release:
            type: string
            example: "14 August 2015"
          pre_unit:
            type: string
          release_date:
            type: string
            format: date-time
          source:
            type: string
          summary:
            type: string
          title:
            type: string
          unit:
            type: string
        required:
          - summary
          - title
      matches:
        type: object
        properties:
          description:
            type: object
            properties:
              dataset_id:
                type: array
                items:
                  $ref: "#/definitions/MatchDetails"
              edition:
                type: array
                items:
                  $ref: "#/definitions/MatchDetails"
              keywords:
                type: array
                items:
                  $ref: "#/definitions/MatchDetails"
              meta_description:
                type: array
                items:
                  $ref: "#/definitions/MatchDetails"
              summary:
                type: array
                items:
                  $ref: "#/definitions/MatchDetails"
              title:
                type: array
                items:
                  $ref: "#/definitions/MatchDetails"
      type:
        type: string
      uri:
        type: string
    required:
      - description
      - type
      - uri

  DepartmentItem:
    type: object
    properties:
      code:
        type: string
      name:
        type: string
      url:
        type: string
      terms:
        type: array
        items:
          type: string
      matches:
        type: array
        items:
          type: object
          properties:
            terms:
              type: array
              items:
                $ref: "#/definitions/MatchDetails"

  MatchDetails:
    description: "A pair of integers to define the start and end of substring in the member that matched the search terms. The first character of the string is index 1."
    type: object
    properties:
      value:
        type: string
        description: "For matches in keys that are part of an array, this will contain the value containing a match."
      start:
        type: integer
        description: "An integer to define the start byte of a substring in the member that matched. The first character of the string is index 1."
        example: 3
      end:
        type: integer
        description: "An integer to define the end byte of a substring in the member that matched."
        example: 8
    required:
      - start
      - end

  Health:
    type: object
    properties:
      elasticsearch:
        type: string
      dp_fasttext:
        type: string
        example: available
